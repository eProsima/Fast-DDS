/*************************************************************************************************/
/**********                          STEPS FOR JENKINS PROJECT                          **********/
/*************************************************************************************************/

STEP 1:
	// copy the previous output files to avoid issues in the configuration page during the building process
	mkdir -p /mnt/perfshare/${subfolder}
	mkdir -p /mnt/perfshare/${subfolder}/output
	chmod a+w /mnt/perfshare/${subfolder}
	chmod a+w /mnt/perfshare/${subfolder}/output
	mkdir -p "/workspace/Multi-Node Manual Linux/output"
	chmod a+w "/workspace/Multi-Node Manual Linux/output"
	/bin/cp -rf /mnt/perfshare/${subfolder}/output/*.csv "/workspace/Multi-Node Manual Linux/output"

STEP 2:
	// Clean old dockers
	for ip in ${publisher_ips}; do docker -H $ip stop $(docker -H $ip ps -q --filter="name=TestPub") || true; done
	for ip in ${subscriber_ips}; do docker -H $ip stop $(docker -H $ip ps -q --filter="name=TestSub") || true; done

	for ip in ${publisher_ips}; do docker -H $ip rm $(docker -H $ip ps -q --filter="name=TestPub") || true; done
	for ip in ${subscriber_ips}; do docker -H $ip rm $(docker -H $ip ps -q --filter="name=TestSub") || true; done

STEP 3:
	// Build FastRTPS
	mkdir build && cd build
	cmake .. -DTHIRDPARTY=ON -DPERFORMANCE_TESTS=ON -DVIDEO_TESTS=ON -DMEMORY_TESTS=ON
	make

STEP 4:
	// Copy Binary files
	mkdir -p /mnt/perfshare/${subfolder}
	mkdir -p /mnt/perfshare/${subfolder}/output
	chmod a+w /mnt/perfshare/${subfolder}
	chmod a+w /mnt/perfshare/${subfolder}/output
	cp "/workspace/Multi-Node Manual Linux/build/src/cpp/libfastrtps.so.1.6.0" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/src/cpp/libfastrtps.so.1" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/src/cpp/libfastrtps.so" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/thirdparty/fastcdr/src/cpp/libfastcdr.so.1.0.7" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/thirdparty/fastcdr/src/cpp/libfastcdr.so" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/test/performance/LatencyTest" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/test/performance/ThroughputTest" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/test/performance/VideoTest" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/build/test/memory/MemoryTest" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/memory/memory_analysis.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/memory/memory_tests.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/GenerateTestsAndXMLs.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/PublisherTests.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/SubscriberTests.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/AnalyzeTests.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/LaunchTests.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/CopyAndRenameCSV.py" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_16.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_32.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_64.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_128.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_256.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_512.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_1024.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_2048.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_4096.csv" /mnt/perfshare/${subfolder}
	cp "/workspace/Multi-Node Manual Linux/test/performance/payloads_demands_8192.csv" /mnt/perfshare/${subfolder}

STEP 5:
	// Launch Tests
	python3 "/mnt/perfshare/${subfolder}/LaunchTests.py" ${publisher_ips} ${subscriber_ips} ${subfolder} ${docker_image}

STEP 6:
	// Copy and Rename output files
	python3 "/mnt/perfshare/${subfolder}/CopyAndRenameCSV.py" "/mnt/perfshare/${subfolder}/output" "/mnt/perfshare/${subfolder}/csv"

STEP 7:
	// Analize results
	python3 "/mnt/perfshare/${subfolder}/AnalyzeTests.py" "/mnt/perfshare/${subfolder}/csv"

STEP 8:
	// Copy the output files to be used by the plots.
	/bin/cp -rf /mnt/perfshare/${subfolder}/output/*.csv "/workspace/Multi-Node Manual Linux/output"
	